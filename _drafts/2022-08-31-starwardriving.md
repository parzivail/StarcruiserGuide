---
published: false
layout: post
subtitle: Speaking dBeacon for fun and profit
title: StarWardriving
---
# Background

In a [previous post](/swge-inspector/), I discussed the details of a BLE datalogging platform, dubbed the "SWGE Inspector". During a recent visit to Galaxy's Edge, I was able to test out the initial hardware setup. In this post we'll discuss the methodology, the raw data, go over some results, and look into some potential areas of improvement.

# Setup 

## Hardware

The sensor platform was modified to include an nRF51822-based BLE packet sniffer [from Adafruit](https://www.adafruit.com/product/2269). This prevented the original Bluetooth dongle from performing double-duty and instead solely as a connection point to [the monitoring app, Stardust](https://github.com/parzivail/SwgeStardust). It also had the advantage of producing a pcap-compatible file with useful metadata like BLE packet RSSI, channel, and status flags. Unfortunately, the sniffer had no attachment point for an external antenna, so the chip antenna's performance had to suffice. The platform was otherwise as described.

Additionally, an Android device running a patched version of Play Disney Parks v2.21.1 was used to log app communication both between the Datapad native and web layer but between the Datapad and beacon system. The logging patch was adapted from the one described in [this post](breaking-the-loop/). This Android device also ran Stardust.

## Software

The SWGE Inspector's Pi 4 ran a copy of [SwgeInspector](https://github.com/parzivail/SwgeInspector) whose primary function was to ingest data from the sensor suite and log them unmodified to a file with timestamps, and to serve basic statistics to Stardust.

On a remote desktop, a copy of [SwgeDatapadEmulator](https://github.com/parzivail/SwgeDatapadEmulator) ran to host a WebSocket server for the patched Datapad to communicate with. It timestamped and saved all of the socket activity generated by the logging patch.

After the data had been collected, the data was processed by the Unpacker project in SwgeInspector.

# Data Processing

All told, the 3-hour jaunt at Galaxy's Edge generated about 100 megabytes of raw data.

| Source | Size |
| :-- | --: |
| BLE Packets | 8.4 MiB |
| GPS NMEA Sentences | 10.5 MiB |
| IMU Data | 37.2 MiB |
| Datapad Logs | 38.5 MiB |
| **Total** | 94.6 MiB |

## Time synchronizing

The Pi 4 has an RTC but no backup battery, and as long as power is disconnected, the system clock is frozen in time. This is typically remediated by connecting to an NTP server at boot, but the airgapped Pi remained unconnected throughout the trip. Luckily, the constant stream of GPS-synchronized UTC timestamps from the GPS allow the offset to be determined each boot between the current system time and UTC.

## GPS

Each of the incoming packets are timestamped, but I also wanted them to be position-stamped so they can be plotted on a map. When the GPS has a fix, it will emit coordinates at 1 Hz, but more often than not, BLE packets and Datapad log packets are recieved by the system at some instant between two coordinate fixes. The easiest solution was to commit GIS heresy and linearly interpolate between the GPS fixes at the instant the packets are received.

I also filtered out fixes that had fewer than 10 satellites providing the fix. Only 4 are required for a basic fix, but 10 was arbitrarily chosen as a good compromise between keeping many points while discarding low-quality indoor points.

## BLE
